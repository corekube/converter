build:
  box: golang
  # The steps that will be executed in the build pipeline
  steps:
    # noop
    - script:
        name: noop (for now)
        code: |
          echo

  # Notify slack of build status
  after-steps:
    # Notify slack
    - slack-notifier:
        url: $SLACK_URL
        channel: notifications
        username: $SLACK_USER

deploy:
  box: golang
  # The steps that will be executed in the DEPLOY pipeline

  # Stage deploy target
  stage:
    - install-packages:
      packages: wget openssh-client

    - add-ssh-key:
        keyname: KUBERNETES_SSH_KEY
    - add-to-known_hosts:
        hostname: $KUBERNETES_MASTER_PUBLIC_IP
        fingerprint: $KUBERNETES_MASTER_FINGERPRINT1
    - add-to-known_hosts:
        hostname: $KUBERNETES_MASTER_PUBLIC_IP
        fingerprint: $KUBERNETES_MASTER_FINGERPRINT2

    # Setup kubectl
    - script:
        name: download & setup kubectl
        code: |
          wget -O /tmp/setup-kubectl.sh https://gist.githubusercontent.com/metral/ce436c6d70b4324262b8dcbd81ce8f34/raw/f3248247281f663ff4471cce0bc54f01aad59bb6/setup-wercker-kubectl.sh
          chmod +x /tmp/setup-kubectl.sh
          ./tmp/setup-kubectl.sh

    # rollout
    - script:
        name: rollout to stage
        code: |
          ./rollout.sh -e stage

  # Prod deploy target
  prod:
    - install-packages:
      packages: curl wget openssh-client

    - add-ssh-key:
        keyname: KUBERNETES_SSH_KEY
    - add-to-known_hosts:
        hostname: $KUBERNETES_MASTER_PUBLIC_IP
        fingerprint: $KUBERNETES_MASTER_FINGERPRINT1
    - add-to-known_hosts:
        hostname: $KUBERNETES_MASTER_PUBLIC_IP
        fingerprint: $KUBERNETES_MASTER_FINGERPRINT2

    # Setup kubectl
    - script:
        name: download & setup kubectl
        code: |
          wget -O /tmp/setup-kubectl.sh https://gist.githubusercontent.com/metral/ce436c6d70b4324262b8dcbd81ce8f34/raw/f3248247281f663ff4471cce0bc54f01aad59bb6/setup-wercker-kubectl.sh
          chmod +x /tmp/setup-kubectl.sh
          ./tmp/setup-kubectl.sh

    # rollout
    - script:
        name: rollout to prod
        code: |
          ./rollout.sh -e prod

  # Notify slack of build status
  after-steps:
    # Notify slack
    - slack-notifier:
        url: $SLACK_URL
        channel: notifications
        username: $SLACK_USER
